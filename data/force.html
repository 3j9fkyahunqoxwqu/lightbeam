<!DOCTYPE hmtl>
<meta charset="utf-8">
<title>Collusion</title>
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
<script src="d3.js"></script>
<style>
circle.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

marker {
  stroke: none;
  fill: #999;
  fill-opacity: .6;  
}

line.link {
  stroke: #999;
  stroke-opacity: .6;
}

html, body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-size: 9pt;
}

#sidebar {
  position: absolute;
  top: 0px;
  left: 0px;
  width: 200px;
  padding: 20px;
}

blockquote {
  margin-left: 10px;
  font-style: italic;
}

.attribution {
  margin-left: 20px;
}
</style>
<div id="sidebar">
  <h1>Collusion</h1>
  <blockquote>If you're not paying for something, you're not the customer; you're the product being sold.</blockquote><span class="attribution">- Andrew Lewis</span>
  <p>This is an interactive visualization of browser cookies. Hover over a node to learn more about it, and drag the nodes around to see more of the graph.</p>
  <div id="info">
    <h2 class="domain"></h2>
  
    <div class="referrers">
      <p>The site <a target="_blank" class="domain"></a> tracks your behavior across the following websites.</p>
      <ul></ul>
    </div>
  </div>
</div>
<div id="chart"></div>
<script src="d3.layout.js"></script>
<script src="d3.geom.js"></script>
<script>
var w = 960,
    h = 500,
    fill = d3.scale.category20();

var vis = d3.select("#chart")
  .append("svg:svg")
    .attr("width", w)
    .attr("height", h);

vis.append("svg:defs")
  .append("svg:marker")
    .attr("id", "Triangle")
    .attr("viewBox", "0 0 10 10")
    .attr("refX", 30)
    .attr("refY", 5)
    .attr("markerUnits", "strokeWidth")
    .attr("markerWidth", 4*2)
    .attr("markerHeight", 3*2)
    .attr("orient", "auto")
    .append("svg:path")
      .attr("d", "M 0 0 L 10 5 L 0 10 z");

vis.append("svg:g").attr("class", "links");
vis.append("svg:g").attr("class", "nodes");

function createNodes(nodes, force) {
  function getReferringLinkCount(d) {
    return selectReferringLinks(d)[0].length;
  }
  
  function radius(d) {
    var added = getReferringLinkCount(d) / 3;
    if (added > 7)
      added = 7;
    return 4 + added;
  }
  
  function groupFill(d) {
    return fill(1 + getReferringLinkCount(d));
  }
  
  function selectArcs(d) {
    return vis.selectAll("line.to-" + d.index +
                         ",line.from-" + d.index);
  }
  
  var node = vis.select("g.nodes").selectAll("circle.node")
      .data(nodes);

  node.transition()
      .duration(1000)
      .attr("r", radius)
      .style("fill", groupFill);

  node.enter().append("svg:circle")
      .attr("class", "node")
      .attr("cx", function(d) { return d.x; })
      .attr("cy", function(d) { return d.y; })
      .attr("r", radius)
      .style("fill", groupFill)
      .call(force.drag)
      .on("mouseout", function(d) {
        selectArcs(d).attr("marker-end", null);
      })
      .on("mouseover", function(d) {
        selectArcs(d).attr("marker-end", "url(#Triangle)");

        $("#info").find(".domain").text(d.name);
        $("#info").find("a.domain").attr("href", "http://" + d.name);
        var referrers = $("#info").find(".referrers");
        var domains = findReferringDomains(d);
        if (domains.length) {
          var list = referrers.find("ul");
          list.empty();
          domains.forEach(function(name) {
            list.append('<li><a target="_blank" href="http://' +
                        name + '">' + name + '</a></li>');
          });
          referrers.show();
        } else {
          referrers.hide();
        }
        $("#info").fadeIn();
      });

  node.append("svg:title")
      .text(function(d) { return d.name; });

  return node;
}

function createLinks(links) {
  var link = vis.select("g.links").selectAll("line.link")
      .data(links)
    .enter().append("svg:line")
      .attr("class", function(d) { return "link from-" + d.source.index +
                                   " to-" + d.target.index; })
      .style("stroke-width", 1)
      .attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; });

  return link;
}

function draw(json) {
  var force = d3.layout.force()
      .charge(-120)
      .distance(60)
      .friction(0)
      .nodes(json.nodes)
      .links(json.links)
      .size([w, h])
      .start();

  createLinks(json.links);
  createNodes(json.nodes, force);
  
  vis.style("opacity", 1e-6)
    .transition()
      .duration(1000)
      .style("opacity", 1);

  force.on("tick", function() {
     vis.selectAll("line.link").attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    vis.selectAll("circle.node").attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; });
  });
  
  return {
    vis: vis,
    force: force
  };
}

function selectReferringLinks(d) {
  return vis.selectAll("line.to-" + d.index);
}

function findReferringDomains(d, list, domain) {
  if (!list) {
    list = [];
    domain = d.name;
  }
  
  selectReferringLinks(d).each(function(d) {
    if (list.indexOf(d.source.name) == -1 &&
        d.source.name != domain) {
      list.push(d.source.name);
      findReferringDomains(d.source, list, domain);
    }
  });

  return list;
}
</script>
<script src="jquery.min.js"></script>
<script>
function CollusionGraph() {
  var nodes = [];
  var links = [];
  var domainIds = {};

  function getNodeId(domain) {
    if (!(domain in domainIds)) {
      domainIds[domain] = nodes.length;
      nodes.push({name: domain});
    }
    return domainIds[domain];
  }

  function addLink(options) {
    var fromId = getNodeId(options.from);
    var toId = getNodeId(options.to);
    var link = vis.select("line.to-" + toId + ".from-" + fromId);
    if (!link[0][0])
      links.push({source: fromId, target: toId});
  }

  var drawing = draw({nodes: nodes, links: links});

  return {
    update: function(json) {
      drawing.force.stop();

      for (var domain in json)
        for (var referrer in json[domain])
          addLink({from: referrer, to: domain});

      drawing.force.nodes(nodes);
      drawing.force.links(links);
      drawing.force.start();
      createLinks(links);
      createNodes(nodes, drawing.force);
    }
  };
}

$(window).ready(function() {
  $("#info").hide();
  
  var graph = CollusionGraph();
  var timeoutID = null;

  if (window.onGraph) {
    window.onGraph(function(json) {
      if (timeoutID !== null)
       clearTimeout(timeoutID);
      timeoutID = setTimeout(function() {
        timeoutID = null;
        graph.update(json);
      }, 250);
    });
  } else
    jQuery.getJSON("sample-tracking-info-over-time.json", function(json) {
      json.reverse();
      function showNextBrowse() {
        if (json.length)
          graph.update(json.pop());
      }
      window.addEventListener("click", showNextBrowse, false);
      showNextBrowse();
    });
});
</script>
