<!DOCTYPE hmtl>
<meta charset="utf-8">
<title>Collusion</title>
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
<script src="d3.js"></script>
<style>
circle.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

marker {
  stroke: none;
  fill: #999;
  fill-opacity: .6;  
}

line.link {
  stroke: #999;
  stroke-opacity: .6;
}

html, body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-size: 9pt;
}

a {
  color: black;
}

#sidebar {
  position: absolute;
  top: 0px;
  left: 0px;
  width: 200px;
  padding: 20px;
}

#info {
  position: absolute;
  top: 0px;
  right: 0px;
  width: 200px;
  padding: 20px;
}

blockquote {
  margin-left: 10px;
  font-style: italic;
}

h2.domain img.favicon {
  width: 16px;
  height: 16px;
  padding-right: 4px;
}

.attribution {
  margin-left: 20px;
}

.tracker {
  color: #d62728;
  fill: #d62728;
}

.site {
  color: #7f7f7f;
  fill: #7f7f7f;
}

.demo span.next {
  cursor: pointer;
  font-weight: bold;
}

.demo span.next:hover, a:hover {
  background: yellow;
}
</style>
<div id="sidebar">
  <h1>Collusion</h1>
  <div class="exposition">
    <blockquote>If you're not paying for something, you're not the customer; you're the product being sold.</blockquote><span class="attribution">- Andrew Lewis</span>
    <p>This page provides an interactive, real-time visualization of the entities that track your behavior across the web.</p>
  </div>
  <div class="live-data" style="display: none;">
    <p>Keep browsing the web. As you do so, a graph on this page will change. Each dot represents a website.</p>
    <p>Sites in <span class="tracker">red</span> are confirmed trackers by <a href="http://privacychoice.org">privacychoice.org</a>. Sites in <span class="site">gray</span> are not, but this doesn't necessarily mean they don't collect data on you.</p>
    <p>Hover your mouse over the dots to learn more about them.</p>
  </div>
  <div class="demo" style="display: none;">
    <div class="step 0">
      <p>Since you don't seem to have the <a href="https://secure.toolness.com/xpi/collusion.html">Collusion Firefox add-on</a> installed, we'll show you a demo of the software. If you install the add-on, you can see the collusion graph change in real-time as you browse the web.</p>
      <p><span class="next">Click here</span> to see what happens when you start your browser and visit the Internet Movie Database at imdb.com.</p>
    </div>
    <div class="step 1">
      <p>Check it out! Each dot in this graph represents a website. The gray dot in the middle is imdb.com; the red dots near it are advertising sites that have created <a href="http://en.wikipedia.org/wiki/HTTP_cookie">cookies</a> in your browser and are now tracking your behavior on the IMDB.</p>
      <p>Hover your mouse over any of the sites to learn more about them.</p>
      <p>When you're done, <span class="next">click here</span> to continue your web adventure. Our next stop is the New York Times website.</p>
    </div>
    <div class="step 2">
      <p>It looks like the New York Times is affiliated with some of the same advertising companies as the IMDB.</p>
      <p>Because the same cookies were transmitted to the same advertisers when you visited both sites, those advertisers effectively track you <em>across</em> them. That's valuable data for their market research.</p>
      <p>When you're ready, <span class="next">click here</span> to visit our next stop, the Huffington Post.</p>
    </div>
    <div class="step 3">
      <p>Even more awesome collusion.</p>
      <p>By the way, sites in <span class="tracker">red</span> are confirmed behavior trackers by <a href="http://privacychoice.org">privacychoice.org</a>. Sites in <span class="site">gray</span> are not, but this doesn't necessarily mean they don't collect data on you.</p>
      <p>If the graph is starting to look a bit confusing, try dragging the dots around with your mouse to get a better view.</p>
      <p>Then, <span class="next">click here</span> to go to our next stop, gamespot.com.</p>
    </div>
    <div class="step 4">
      <p>If you haven't realized it yet, companies are tracking you across most of the sites you visit daily on the web. It's quite likely that these companies know more about you than your government. Some of them might even know more about you than your best friends.</p>
      <p><span class="next">Click here</span> to visit our final stop, reference.com.</p>
    </div>
    <div class="step 5">
      <p>Thanks for trying out this demo. If you'd like to see this graph change in real time based on the sites you visit in your own browser, feel free to try the <a href="https://secure.toolness.com/xpi/collusion.html">Collusion Firefox add-on</a>. Even visiting the sites mentioned in the demo will probably give you different visualizations, because some services you may be logged into&mdash;like Facebook&mdash;can also track you across sites.</p>
      <p>If you want to block companies from tracking you on the internet, you can install <a href="http://www.privacychoice.org/trackerblock/firefox">TrackerBlock</a> for Firefox and Internet Explorer.</p>
      <p>For more in-depth analysis of what all this could mean for society at large, read <a href="http://www.amazon.com/Filter-Bubble-Internet-Hiding-Pariser/dp/067092038X/ref=tmm_pap_title_0">The Filter Bubble</a> by Eli Pariser.</p>
      <p>Finally, if you have any questions or concerns about this demo, feel free to contact its author, <a href="http://twitter.com/toolness">@toolness</a>.</p>
    </div>
  </div>
</div>
<div id="info" style="display: none;">
  <h2 class="domain"></h2>

  <div class="referrers">
    <p>The site <a target="_blank" class="domain"></a> tracks your behavior across the following websites.</p>
    <ul></ul>
  </div>
</div>
<div id="chart"></div>
<script src="d3.layout.js"></script>
<script src="d3.geom.js"></script>
<script src="jquery.min.js"></script>
<script>
var w = 640,
    h = 480;

var vis = d3.select("#chart")
  .append("svg:svg")
    .attr("width", w)
    .attr("height", h);

vis.append("svg:defs")
  .append("svg:marker")
    .attr("id", "Triangle")
    .attr("viewBox", "0 0 10 10")
    .attr("refX", 30)
    .attr("refY", 5)
    .attr("markerUnits", "strokeWidth")
    .attr("markerWidth", 4*2)
    .attr("markerHeight", 3*2)
    .attr("orient", "auto")
    .append("svg:path")
      .attr("d", "M 0 0 L 10 5 L 0 10 z");

vis.append("svg:g").attr("class", "links");
vis.append("svg:g").attr("class", "nodes");

jQuery.fn.extend({
  setDomainLink: function(d) {
    this.removeClass("tracker").removeClass("site");
    if (d.trackerInfo) {
      var TRACKER_INFO = "http://www.privacychoice.org/companies/index/";
      var trackerId = d.trackerInfo.network_id;
      this.attr("href", TRACKER_INFO + trackerId);
      this.addClass("tracker");
    } else {
      this.attr("href", "http://" + d.name);
      this.addClass("site");
    }
  }
});

function showDomainInfo(d) {
  $("#info").find(".domain").text(d.name);
  var img = $('<img>');
  if (d.trackerInfo) {
    var TRACKER_LOGO = "http://images.privacychoice.org/images/network/";
    var trackerId = d.trackerInfo.network_id;
    $("#info").find("h2.domain").empty();
    img.attr("src", TRACKER_LOGO + trackerId + ".jpg").addClass("tracker");
  } else {
    img.attr("src", 'http://' + d.name + '/favicon.ico').addClass("favicon");
  }
  $("#info").find("a.domain").setDomainLink(d);
  $("#info").find("h2.domain").prepend(img);
  img.load(function() { img.show(); })
     .error(function() { img.remove(); })
     .hide();
  var referrers = $("#info").find(".referrers");
  var domains = findReferringDomains(d);
  if (domains.length) {
    var list = referrers.find("ul");
    list.empty();
    domains.forEach(function(d) {
      var item = $('<li><a target="_blank"></a></li>');
      item.find("a").text(d.name).setDomainLink(d);
      list.append(item);
    });
    referrers.show();
  } else {
    referrers.hide();
  }
  $("#info").fadeIn();
}

function createNodes(nodes, force) {
  function getReferringLinkCount(d) {
    return selectReferringLinks(d)[0].length;
  }
  
  function radius(d) {
    var added = getReferringLinkCount(d) / 3;
    if (added > 7)
      added = 7;
    return 4 + added;
  }
  
  function selectArcs(d) {
    return vis.selectAll("line.to-" + d.index +
                         ",line.from-" + d.index);
  }
  
  var node = vis.select("g.nodes").selectAll("circle.node")
      .data(nodes);

  node.transition()
      .duration(1000)
      .attr("r", radius)

  node.enter().append("svg:circle")
      .attr("class", function(d) {
        return "node " + (d.trackerInfo ? "tracker" : "site");
      })
      .attr("cx", function(d) { return d.x; })
      .attr("cy", function(d) { return d.y; })
      .attr("r", radius)
      .call(force.drag)
      .on("mouseout", function(d) {
        selectArcs(d).attr("marker-end", null);
      })
      .on("mouseover", function(d) {
        selectArcs(d).attr("marker-end", "url(#Triangle)");
        showDomainInfo(d);
      })
      .append("svg:title")
      .text(function(d) { return d.name; });

  return node;
}

function createLinks(links) {
  var link = vis.select("g.links").selectAll("line.link")
      .data(links)
    .enter().append("svg:line")
      .attr("class", function(d) { return "link from-" + d.source.index +
                                   " to-" + d.target.index; })
      .style("stroke-width", 1)
      .attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; });

  return link;
}

function draw(json) {
  var force = d3.layout.force()
      .charge(-120)
      .distance(60)
      .friction(0)
      .nodes(json.nodes)
      .links(json.links)
      .size([w, h])
      .start();

  createLinks(json.links);
  createNodes(json.nodes, force);
  
  vis.style("opacity", 1e-6)
    .transition()
      .duration(1000)
      .style("opacity", 1);

  force.on("tick", function() {
     vis.selectAll("line.link").attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    vis.selectAll("circle.node").attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; });
  });
  
  return {
    vis: vis,
    force: force
  };
}

function selectReferringLinks(d) {
  return vis.selectAll("line.to-" + d.index);
}

function findReferringDomains(d, list, domain) {
  if (!list) {
    list = [];
    domain = d.name;
  }
  
  selectReferringLinks(d).each(function(d) {
    if (list.indexOf(d.source) == -1 &&
        d.source.name != domain) {
      list.push(d.source);
      findReferringDomains(d.source, list, domain);
    }
  });

  return list;
}
</script>
<script>
function CollusionGraph(trackers) {
  var nodes = [];
  var links = [];
  var domainIds = {};

  function getNodeId(domain) {
    if (!(domain in domainIds)) {
      domainIds[domain] = nodes.length;
      var trackerInfo = null;
      for (var i = 0; i < trackers.length; i++)
        if (trackers[i].domain == domain) {
          trackerInfo = trackers[i];
          break;
        }
      nodes.push({
        name: domain,
        trackerInfo: trackerInfo
      });
    }
    return domainIds[domain];
  }

  function addLink(options) {
    var fromId = getNodeId(options.from);
    var toId = getNodeId(options.to);
    var link = vis.select("line.to-" + toId + ".from-" + fromId);
    if (!link[0][0])
      links.push({source: fromId, target: toId});
  }

  var drawing = draw({nodes: nodes, links: links});

  return {
    update: function(json) {
      drawing.force.stop();

      for (var domain in json)
        for (var referrer in json[domain])
          addLink({from: referrer, to: domain});

      drawing.force.nodes(nodes);
      drawing.force.links(links);
      drawing.force.start();
      createLinks(links);
      createNodes(nodes, drawing.force);
    }
  };
}

function showDemo(graph) {
  jQuery.getJSON("sample-tracking-info-over-time.json", function(json) {
    json.reverse();
    $(".demo").find(".step").hide();
    $(".demo").show();
    $(".demo").find(".step.0").fadeIn();

    var step = 0;

    function showNextStep() {
      $(".exposition").slideUp();
      $(".demo").find(".step." + step).fadeOut(function() {
        step++;
        $(".demo").find(".step." + step).fadeIn();
        graph.update(json.pop());
      });
    }

    $(".demo").find(".next").click(showNextStep);
  });
}

function showLiveBrowserData(graph) {
  var timeoutID = null;

  $(".live-data").fadeIn();

  window.onGraph(function(json) {
    if (timeoutID !== null)
     clearTimeout(timeoutID);
    timeoutID = setTimeout(function() {
      timeoutID = null;
      graph.update(json);
    }, 250);
  });
}

$(window).ready(function() {
  jQuery.getJSON("trackers.json", function(trackers) {  
    var graph = CollusionGraph(trackers);

    if (window.onGraph)
      showLiveBrowserData(graph);
    else
      showDemo(graph);
  });
});
</script>
