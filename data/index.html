<!DOCTYPE hmtl>
<meta charset="utf-8">
<meta name="viewport" content="width=640">
<title>Collusion</title>
<base target="_blank">
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
<script src="d3.js"></script>
<style>
circle.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

marker {
  stroke: none;
  fill: #999;
  fill-opacity: .6;  
}

line.link {
  stroke: #999;
  stroke-opacity: .6;
}

html, body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-size: 9pt;
  margin: 0;
  padding: 0;
}

a {
  color: black;
}

#page {
  position: relative;
  width: 640px;
}

#sidebar {
  position: absolute;
  top: 0px;
  left: 0px;
  width: 200px;
  padding: 20px;
  pointer-events: none;
}

div.info {
  position: absolute;
  top: 0px;
  right: 0px;
  width: 200px;
  padding: 20px;
  pointer-events: none;
}

#sidebar a, .info a, span.next {
  pointer-events: auto;
}

blockquote {
  margin-left: 10px;
  font-style: italic;
}

h2.domain img.favicon {
  width: 16px;
  height: 16px;
  padding-right: 4px;
}

h2.domain img.tracker {
  height: 30px;
}

.attribution {
  margin-left: 20px;
}

.tracker {
  color: #d62728;
  fill: #d62728;
}

.site {
  color: #7f7f7f;
  fill: #7f7f7f;
}

.demo span.next {
  cursor: pointer;
  font-weight: bold;
}

.demo span.next:hover, a:hover {
  background: yellow;
}

.byline {
  margin-top: -10px;
}

.live-data {
  background-color: rgba(0, 0, 0, 0.1);
  padding: 5px;
  margin-top: 15px;
}

#addon-installation-detected {
  position: fixed;
  top: 0px;
  left: 0px;
  background-color: green;
  padding: 5px;
  color: white;
  width: 100%;
  text-align: center;
}

.privacy-policy {
  font-size: 8pt;
}

div.settings-menu {
  padding: 5px;
  pointer-events: auto;
  color: white;
  background: rgba(0, 0, 0, 0.75);
}

div.settings-menu > ul {
  list-style-type: none;
  margin: 0px;
  padding: 0px;
  font-size: 8pt;
}

div.settings-menu > ul > li {
  cursor: pointer;
}

div.settings-menu > ul > li:hover {
  color: yellow;
  background: black;
}
</style>
<div id="page">
<div id="sidebar">
  <h1>Collusion</h1>
  <div class="byline">By <a href="http://twitter.com/toolness">@toolness</a></div>
  <div class="exposition">
    <blockquote>If you're not paying for something, you're not the customer; you're the product being sold.</blockquote><span class="attribution">- Andrew Lewis</span>
    <p>This page provides an interactive, real-time visualization of the entities that track your behavior across the web.</p>
  </div>
  <div class="live-data" style="display: none;">
    <p>Keep browsing the web. As you do so, a graph on this page will change. Each dot represents a website.</p>
    <p>Sites in <span class="tracker">red</span> are confirmed trackers by <a href="http://privacychoice.org">privacychoice.org</a>. Sites in <span class="site">gray</span> are not, but this doesn't necessarily mean they don't collect data on you.</p>
    <p>Hover your mouse over the dots to learn more about them.</p>
    <div class="settings-menu">
      <ul>
        <li id="reset-graph">Reset Graph</li>
      </ul>
    </div>
    <p class="privacy-policy"><strong>Privacy Policy</strong> When you're using the add-on, we collect sites you visit solely to show you how they're connected. We don't keep them and don't give away the information to anyone except you.</p>
  </div>
  <div class="demo" style="display: none;">
    <div class="step 0">
      <p>Since you don't seem to have the <a href="https://secure.toolness.com/xpi/collusion.html">Collusion Firefox add-on</a> installed, we'll show you a demo of the software.</p>
      <p><span class="next">Click here</span> to see what happens when you start your browser and visit the Internet Movie Database at imdb.com.</p>
    </div>
    <div class="step 1">
      <p>Each dot in this graph represents a website. The gray dot in the middle is imdb.com; the red dots near it are advertising sites that have created <a href="http://en.wikipedia.org/wiki/HTTP_cookie">cookies</a> in your browser and are now tracking your behavior on the IMDB.</p>
      <p>The advertising sites are colored red because <a href="http://privacychoice.org">privacychoice.org</a> has determined that they're behavioral tracking sites. But just because a dot isn't red doesn't necessarily mean it's not tracking you.</p>
      <p>Hover your mouse over any of the sites to learn more about them.</p>
      <p>When you're done, <span class="next">click here</span> to continue your web adventure. Our next stop is the New York Times website.</p>
    </div>
    <div class="step 2">
      <p>It looks like the New York Times is affiliated with some of the same advertising companies as the IMDB.</p>
      <p>Because the same cookies were transmitted to the same advertisers when you visited both sites, those advertisers effectively track you <em>across</em> them. That's valuable data for their market research.</p>
      <p>When you're ready, <span class="next">click here</span> to visit our next stop, the Huffington Post.</p>
    </div>
    <div class="step 3">
      <p>Some companies are already using their knowledge about you to determine what you see on the sites they're affiliated with&mdash;not just the ads you see, but the actual content you read. Eli Pariser examines what this could mean for society at large in his book <a href="http://www.amazon.com/Filter-Bubble-Internet-Hiding-Pariser/dp/067092038X/ref=tmm_pap_title_0">The Filter Bubble</a>.</p>
      <p>By the way, if the graph is starting to look a bit confusing, try dragging the dots around with your mouse to get a better view.</p>
      <p>Then, <span class="next">click here</span> to go to our next stop, gamespot.com.</p>
    </div>
    <div class="step 4">
      <p>If you haven't realized it yet, companies are tracking you across most of the sites you visit daily on the web. It's quite likely that these companies know more about you than your government. Some of them might even know more about you than your best friends.</p>
      <p><span class="next">Click here</span> to visit our final stop, reference.com.</p>
    </div>
    <div class="step 5">
      <p>Thanks for trying out this demo. If you'd like to see this graph change in real time based on the sites you visit in your own browser, feel free to try the <a href="https://secure.toolness.com/xpi/collusion.html">Collusion Firefox add-on</a>. Even visiting the sites mentioned in the demo will probably give you different visualizations, because some services you may be logged into&mdash;like Facebook&mdash;can also track you across sites.</p>
      <p>If you want to block companies from tracking you on the internet, you can install <a href="http://www.privacychoice.org/trackerblock/firefox">TrackerBlock</a> for Firefox and Internet Explorer.</p>
      <p>For more information about the making of this demo, check out the <a href="http://www.toolness.com/wp/2011/07/collusion/">blog post</a> and <a href="https://github.com/toolness/collusion">code repository</a>. Feel free to tweet at <a href="http://twitter.com/toolness">toolness</a> if you have any feedback!</p>
    </div>
  </div>
</div>
<div id="chart"></div>
<div id="domain-infos"></div>
</div>
<div id="addon-installation-detected" style="display: none;">
  Collusion add-on detected! Reload this page to see your graph.
</div>
<div id="templates">
  <div class="info" style="display: none;">
    <h2 class="domain"></h2>

    <div class="referrers">
      <p>The site <a class="domain"></a> tracks your behavior across the following websites.</p>
      <ul></ul>
    </div>
  </div>
</div>
<script src="d3.layout.js"></script>
<script src="d3.geom.js"></script>
<script src="jquery.min.js"></script>
<script>
function isAddonInstalled() {
  return ('onGraph' in window);
}

var SVG_WIDTH = isAddonInstalled() ? $(window).width() : 640,
    SVG_HEIGHT = isAddonInstalled() ? $(window).height() : 480;

var vis = d3.select("#chart")
  .append("svg:svg")
    .attr("width", SVG_WIDTH)
    .attr("height", SVG_HEIGHT);

vis.append("svg:defs")
  .append("svg:marker")
    .attr("id", "Triangle")
    .attr("viewBox", "0 0 10 10")
    .attr("refX", 30)
    .attr("refY", 5)
    .attr("markerUnits", "strokeWidth")
    .attr("markerWidth", 4*2)
    .attr("markerHeight", 3*2)
    .attr("orient", "auto")
    .append("svg:path")
      .attr("d", "M 0 0 L 10 5 L 0 10 z");

vis.append("svg:g").attr("class", "links");
vis.append("svg:g").attr("class", "nodes");

jQuery.fn.extend({
  setDomainLink: function(d) {
    this.removeClass("tracker").removeClass("site");
    if (d.trackerInfo) {
      var TRACKER_INFO = "http://www.privacychoice.org/companies/index/";
      var trackerId = d.trackerInfo.network_id;
      this.attr("href", TRACKER_INFO + trackerId);
      this.addClass("tracker");
    } else {
      this.attr("href", "http://" + d.name);
      this.addClass("site");
    }
  }
});

function showDomainInfo(d) {
  var className = d.name.replace(/\./g, '-dot-');
  var info = $("#domain-infos").find("." + className);

  $("#domain-infos .info").hide();

  if (!info.length) {
    info = $("#templates .info").clone();
    info.addClass(className);
    info.find(".domain").text(d.name);
    var img = $('<img>');
    if (d.trackerInfo) {
      var TRACKER_LOGO = "http://images.privacychoice.org/images/network/";
      var trackerId = d.trackerInfo.network_id;
      info.find("h2.domain").empty();
      img.attr("src", TRACKER_LOGO + trackerId + ".jpg").addClass("tracker");
    } else
      img.attr("src", 'http://' + d.name + '/favicon.ico')
         .addClass("favicon");
    info.find("a.domain").setDomainLink(d);
    info.find("h2.domain").prepend(img);
    img.error(function() { img.remove(); });
    $("#domain-infos").append(info);
  }
  var referrers = info.find(".referrers");
  var domains = findReferringDomains(d);
  if (domains.length) {
    var list = referrers.find("ul");
    list.empty();
    domains.forEach(function(d) {
      var item = $('<li><a></a></li>');
      item.find("a").text(d.name).setDomainLink(d);
      list.append(item);
    });
    referrers.show();
  } else {
    referrers.hide();
  }
  info.show();
}

function createNodes(nodes, force) {
      
  /* Represent each site as a node consisting of an svg group <g>
   * containing a <circle> and an <image>, where the image shows
   * the favicon; circle size shows number of links, color shows
   * type of site. */
      
  function getReferringLinkCount(d) {
    return selectReferringLinks(d)[0].length;
  }
  
  function radius(d) {
    var added = getReferringLinkCount(d) / 3;
    if (added > 7)
      added = 7;
    return 4 + added;
  }
  
  function selectArcs(d) {
    return vis.selectAll("line.to-" + d.index +
                         ",line.from-" + d.index);
  }
  
  var node = vis.select("g.nodes").selectAll("g.node") 
      .data(nodes);

  node.transition()
      .duration(1000)
      .attr("r", radius);
      
  var gs = node.enter().append("svg:g")
      .attr("class", "node")
      .attr("transform", function(d) {
        return "translate(" + d.x + "," + d.y + ")";
      })
      .on("mouseout", function(d) {
        selectArcs(d).attr("marker-end", null);
      })
      .on("mouseover", function(d) {
        selectArcs(d).attr("marker-end", "url(#Triangle)");
        showDomainInfo(d);
      });

  gs.append("svg:circle")
      .attr("cx", "0")
      .attr("cy", "0")
      .attr("r", radius)
      .attr("class", function(d) {
         return "node " + (d.trackerInfo ? "tracker" : "site");
      });

  gs.append("svg:image")
      .attr("class", "node")
      .attr("width", "16")
      .attr("height", "16")
      .attr("x", "-8")
      .attr("y", "-8")
      .attr("xlink:href", function(d) {return 'http://' + d.name + '/favicon.ico'; } )

  gs.append("svg:title")
      .text(function(d) { return d.name; });

  return node;
}

function createLinks(links) {
  var link = vis.select("g.links").selectAll("line.link")
      .data(links)
    .enter().append("svg:line")
      .attr("class", function(d) { return "link from-" + d.source.index +
                                   " to-" + d.target.index; })
      .style("stroke-width", 1)
      .attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; });

  return link;
}

function draw(json) {
  var force = d3.layout.force()
      .charge(-120)
      .distance(60)
      .friction(0)
      .nodes(json.nodes)
      .links(json.links)
      .size([SVG_WIDTH, SVG_HEIGHT])
      .start();

  createLinks(json.links);
  createNodes(json.nodes, force);
  
  vis.style("opacity", 1e-6)
    .transition()
      .duration(1000)
      .style("opacity", 1);

  force.on("tick", function() {
     vis.selectAll("line.link").attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

     vis.selectAll("g.node").attr("transform", function(d) {
        return "translate(" + d.x + "," + d.y + ")";
     });
  });
  
  return {
    vis: vis,
    force: force
  };
}

function selectReferringLinks(d) {
  return vis.selectAll("line.to-" + d.index);
}

function findReferringDomains(d, list, domain) {
  if (!list) {
    list = [];
    domain = d.name;
  }
  
  selectReferringLinks(d).each(function(d) {
    if (list.indexOf(d.source) == -1 &&
        d.source.name != domain) {
      list.push(d.source);
      findReferringDomains(d.source, list, domain);
    }
  });

  return list;
}
</script>
<script>
function CollusionGraph(trackers) {
  var nodes = [];
  var links = [];
  var domainIds = {};

  function getNodeId(domain) {
    if (!(domain in domainIds)) {
      domainIds[domain] = nodes.length;
      var trackerInfo = null;
      for (var i = 0; i < trackers.length; i++)
        if (trackers[i].domain == domain) {
          trackerInfo = trackers[i];
          break;
        }
      nodes.push({
        name: domain,
        trackerInfo: trackerInfo
      });
    }
    return domainIds[domain];
  }

  function addLink(options) {
    var fromId = getNodeId(options.from);
    var toId = getNodeId(options.to);
    var link = vis.select("line.to-" + toId + ".from-" + fromId);
    if (!link[0][0])
      links.push({source: fromId, target: toId});
  }

  var drawing = draw({nodes: nodes, links: links});

  return {
    update: function(json) {
      drawing.force.stop();

      for (var domain in json)
        for (var referrer in json[domain])
          addLink({from: referrer, to: domain});

      drawing.force.nodes(nodes);
      drawing.force.links(links);
      drawing.force.start();
      createLinks(links);
      createNodes(nodes, drawing.force);
    }
  };
}

function showDemo(graph) {
  function findPageLoadIntervals(json, requestReferrer) {
    var requests = [];

    if (typeof(requestRefferer) == "string")
      requestReferrer = [requestReferrer];
      
    for (var domain in json)
      for (var referrer in json[domain]) {
        var time = json[domain][referrer][0];
        if (requestReferrer.indexOf(referrer) != -1) {
          requests.push(time);
        }
      }

    var uniqueRequests = [];
    requests.forEach(function(time) {
      if (uniqueRequests.indexOf(time) == -1)
        uniqueRequests.push(time);
    });

    return uniqueRequests.sort().reverse();
  }

  function getJsonAtTime(json, maxTime) {
    var filtered = {};

    for (var domain in json) {
      filtered[domain] = {};
      for (var referrer in json[domain]) {
        var time = json[domain][referrer][0];
        if (time <= maxTime)
          filtered[domain][referrer] = json[domain][referrer];
      }
    }

    return filtered;
  }
  
  jQuery.getJSON("sample-tracking-info.json", function(json) {
    $(".demo").find(".step").hide();
    $(".demo").show();
    $(".demo").find(".step.0").fadeIn();

    var step = 0;
    var DOMAINS = [
      "imdb.com",
      "nytimes.com",
      ["huffingtonpost.com", "atwola.com"],
      "gamespot.com",
      "reference.com"
    ];

    function showNextStep() {
      $(".exposition").slideUp();
      $(".demo").find(".step." + step).fadeOut(function() {
        var times = findPageLoadIntervals(json, DOMAINS[step]);
        var nextTime = times.pop();
        var virtualTime = 0;

        function triggerNextRequest() {
          virtualTime = nextTime;
          graph.update(getJsonAtTime(json, virtualTime));
          if (times.length) {
            nextTime = times.pop();
            setTimeout(triggerNextRequest, nextTime - virtualTime);
          } else
            $(".demo").find(".step." + step).fadeIn();
        }
        
        triggerNextRequest();

        step++;
      });
    }

    $(".demo").find(".next").click(showNextStep);
  });
}

function makeBufferedGraphUpdate(graph) {
  var timeoutID = null;
  
  return function(json) {
    if (timeoutID !== null)
     clearTimeout(timeoutID);
    timeoutID = setTimeout(function() {
      timeoutID = null;
      
      // This is for debugging purposes only!
      // window.lastJSON = json;
      
      graph.update(json);
    }, 250);
  };
}

$(window).ready(function() {
  if (isAddonInstalled())
    $(".exposition").hide();

  jQuery.getJSON("trackers.json", function(trackers) {  
    var graph = CollusionGraph(trackers);

    $("#page").width(SVG_WIDTH);

    if (isAddonInstalled()) {
      $(".live-data").fadeIn();
      window.onGraph(makeBufferedGraphUpdate(graph));
      $("#reset-graph").click(function() {
        if ('resetGraph' in window) {
          window.resetGraph();
          window.location.reload();
        } else
          alert("You need to update your add-on to use this feature.");
      });
    } else {
      showDemo(graph);
      setInterval(function displayMessageIfAddonIsInstalled() {
        if (isAddonInstalled())
          $("#addon-installation-detected").slideDown();
      }, 1000);
    }
  });
});
</script>
